@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Movie details page";
    var showDates = ViewBag.ShowDates as List<DateTime>;
    var selectedDate = (DateTime)ViewBag.SelectedDate;
    var groupedShowtimes = ViewBag.GroupedShowtimes as List<IGrouping<DoAn.Models.Cinema.Branch, DoAn.Models.Booking.Showtime>>;
}
@model DoAn.Models.Movies.Movie

@section Styles {
    <link rel="stylesheet" href="~/css/movie/details.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/movie/seats.css" asp-append-version="true" />
}

<div class="movie-content-wrapper">
    <div class="movie-image-bg" style="background-image:url(@Model.CoverUrl)"></div>
    <div class="movie-info">
        <div class="movie-info-right">
            <img class="movie-poster" src=@Model.PosterUrl alt="">
            <div class="movie-info-content">
                <!-- <div>16+</div> -->
                <div class="movie-name">@Model.Title</div>
                @* <img class="movie-name-image" width="500" src="https://occ-0-58-64.1.nflxso.net/dnm/api/v6/S4oi7EPZbv2UEPaukW54OORa0S8/AAAABQz4MR6j_-z0wc04tstAaUkTqi5jcqabP8DK-tAU4S8jiVMOD8GyyW0vpf43cCUe22_uEK9RT6ORHfr4ZNuseX9vAPeHGvR3Lg.webp?r=c40" alt=""> *@
                <div class="movie-genres">
                    <p class="movie-genres-item">@Model.Genre</p>
                    @* <p class="movie-genres-item">Bí ẩn</p>
                    <p class="movie-genres-item">Bí ẩn</p> *@
                </div>
                <div class="d-flex gap-2">
                    <i class="bi bi-clock"></i>
                    <div class="time">@Model.Duration</div>
                </div>
                <button class="play-trailer-btn">
                    <span><i class="bi bi-play-fill text-white"></i></span>
                    <span>Xem trailer</span>
                </button>
                <div class="movie-description-wrapper">
                    <div class="movie-description">@Model.Description</div>
                    <button class="toggle-btn">Xem thêm</button>
                </div>
            </div>
        </div>
        <!-- <div class="movie-info-left"></div> -->
    </div>
</div>
<section>
    <div class="cinema-layout">
        <div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="fs-3 fw-bold text-white ">Lịch chiếu</div>
                <div class="d-flex gap-2 text-white ">
                    <i class="bi bi-geo-alt"></i>
                    <div>Hồ Chí Minh</div>
                </div>
            </div>
            <div class="day-list my-4">
                @foreach (var date in (List<DateTime>)ViewBag.ShowDates)
                {
                    var dayName = date.ToString("ddd", new System.Globalization.CultureInfo("vi-VN"));
                    var label = $"{dayName.ToUpper()} - {date:dd/MM}";
                    <button class="btn day @(date == selectedDate ? "active" : "")"
                            data-date="@date.ToString("yyyy-MM-dd")"
                            data-movie="@Model.MovieId">
                        @label
                    </button>
                }
            </div>
            <div class="fs-3 fw-bold text-white">Các rạp</div>
            <div id="showtimes-container">
                @await Html.PartialAsync("_ShowtimesPartial",
                                ((List<IGrouping<DoAn.Models.Cinema.Branch, DoAn.Models.Booking.Showtime>>)ViewBag.GroupedShowtimes))
            </div>
             <div>
                <div class="fs-3 fw-bold text-white">Bình luận</div>
                <div class="mt-2">
                    <input class="comment-input" type="text" placeholder="Viết nhận xét">
                </div>
            </div>
        </div>
        <div class="text-white">
            <div class="fs-3 fw-bold text-white ">Phim đang chiếu</div>
            <div class="movie-list">
                <div class="movie">
                    <img src="../images/100.jpg" loading="lazy" alt="">
                    <div>
                        <div class="fw-bold">Tên phim</div>
                        <div>
                            <div>Kịch tính</div>
                            <div>Bí ẩn</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/details.js" asp-append-version="true"></script>
    <script src="~/js/seats.js" asp-append-version="true"></script>
    <script>
        document.querySelectorAll('.btn.day').forEach(btn => {
            btn.addEventListener('click', function () {
                const movieId = this.dataset.movie;
                const date = this.dataset.date;

                // Bỏ class active cũ
                document.querySelectorAll('.btn.day').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Gửi request AJAX để lấy partial view
                fetch(`/Movie/GetShowtimesPartial?id=${movieId}&date=${date}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('showtimes-container').innerHTML = html;
                    })
                    .catch(err => console.error('Fetch error:', err));
            });
        });
    </script>
}
